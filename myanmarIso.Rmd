---
title: "isotope data"
author: "SC"
date: "`r Sys.time()`"
output: 
    bookdown::html_document2:
        code_folding: show
        section_numbers: true
        toc: true
        toc_depth: 3
        toc_float: true
---

# Isotope data

```{r}
knitr::opts_chunk$set(warning=FALSE,message=FALSE,cache=TRUE,collapse=TRUE,fig.show="hold",results="hide")

fun_range <- function(x,n=100) {                              # Create user-defined function
  (x - min(x)) / (max(x) - min(x)) * 100
}
simpmatch  <-  function(i,j){
    if(length(i)>length(j)){
        tmp=i
        i=j
        j=tmp
    }
    length(na.omit(match(i,j)))
}
source("tools.R")
library(sf)
```
Get all shapefiles
```{r,eval=F}
allshapefiles=lapply(country,function(m) tmpm=readOGR(dsn = "Cartes/", layer=paste0(m,"_adm0") ))
seashapefile=do.call("rbind",allshapefiles)
rmarkdown::render("myanmarIso.Rmd",output_dir="/var/www/html")
```

```{r}
seashapefile=st_read("Cartes/allsea.shp")
seashapefile=st_make_valid(seashapefile)
seashapefile=st_union(seashapefile)

```

```{r,out.width="50%"}
pryce=read.csv("data/DATA isotopie_Pryce_V4.csv")
myanmar=pryce[pryce$Country == "Myanmar",]
myanmar$Easting...Longitude= as.numeric(gsub("°","",myanmar$Easting...Longitude))
myanmar$Northing.Latitude= as.numeric(gsub("°","",myanmar$Northing.Latitude))
myanmar=myanmar[!is.na(myanmar[,6]),]#useless with the new cleaner dataset
ratioiso=c("X208Pb.204Pb","X207Pb.204Pb","X206Pb.204Pb")
myanmar[,ratioiso]=apply(myanmar[,ratioiso],2,as.numeric)
myanmar=myanmar[!is.na(myanmar[,15]),]#useless with the new cleaner dataset
isotopes=myanmar[,ratioiso]
myanmar.pca=prcomp(myanmar[,ratioiso])
myanmar.dist=dist(myanmar.pca$x)
myanmar.clust=hclust(myanmar.dist)
myanmar.kclust=cutree(myanmar.clust,k=10) #playing comparing community cluster vs simple hierarchical clustering
plot(myanmar.pca$x[,1:2],pch=21,bg=rainbow(10,alpha=.6)[myanmar.kclust])
text(myanmar.pca$x[,1],myanmar.pca$x[,2],myanmar$River.basin,pch=21,bg=rainbow(10,alpha=.6)[myanmar.kclust],cex=.4)


plot(myanmar.pca$x[,1:2],pch=21,bg=rainbow(10,alpha=.6)[myanmar.kclust])
text(myanmar.pca$x[,1],myanmar.pca$x[,2],myanmar$Site,pch=21,bg=rainbow(10,alpha=.6)[myanmar.kclust],cex=.4)
```

crop shapefile:

```{r}

plot(st_geometry(seashapefile),reset=F)
points(myanmar$Easting...Longitude,myanmar$Northing.Latitude,pch=21,bg=rainbow(10,alpha=.6)[myanmar.kclust])

coords=colnames(myanmar)[6:7]
myan.sf=st_as_sf(myanmar,coords=coords,crs=st_crs(seashapefile))
windowmyan=st_crop(seashapefile,st_buffer(myan.sf,200000))


plot(st_geometry(windowmyan),reset=F)
points(myanmar$Easting...Longitude,myanmar$Northing.Latitude,pch=21,bg=rainbow(10,alpha=.6)[myanmar.kclust])

text(myanmar[,19],myanmar[,18],myanmar$Site,pch=21,bg=rainbow(10,alpha=.6)[myanmar.kclust],cex=.4)

```


Plot Isotopes ratio classic bi-plot:

```{r}

myanmar$kclust=myanmar.kclust 
qualities=myanmar

par(mfrow=c(1,2))
plot(qualities[,"X206Pb.204Pb"],qualities[,"X207Pb.204Pb"],pch=21,bg=rainbow(10,alpha=.6)[qualities$kclust])
text(qualities[,"X206Pb.204Pb"],qualities[,"X207Pb.204Pb"],qualities$River.basin,cex=.4)
plot(qualities[,"X208Pb.204Pb"],qualities[,"X207Pb.204Pb"],pch=21,bg=rainbow(10,alpha=.6)[qualities$kclust])
text(qualities[,"X208Pb.204Pb"],qualities[,"X207Pb.204Pb"],qualities$River.basin,cex=.4)
text(qualities[,"X208Pb.204Pb"],qualities[,"X207Pb.204Pb"],qualities$LABEL.analytical,cex=.6)

ql.pca=prcomp(qualities[,ratioiso])
ql.dist=dist(ql.pca$x)
ql.clust=hclust(ql.dist)
ql.kclust=cutree(ql.clust,k=5)

oligroup=read.csv("data/group differences.csv")
qualities$klcust=ql.kclust
plot(ql.pca$x[,1:2],pch=21,bg=rainbow(5)[ql.kclust])
text(ql.pca$x[,1],ql.pca$x[,2],qualities$LABEL.analytical,cex=.6)
```


Tsnea and networks:
```{r,fig.height=20,fig.width=20}
nk=6

code=strsplit(myanmar[,1],"/")
code=sapply(code,function(s)paste0(s[3:4],collapse="/"))


library(Rtsne)
isotopes.tsne=Rtsne(isotopes,pca=F,perplexity=10)
isotopes.dist=dist(isotopes.tsne$Y)
isotopes.clust=hclust(isotopes.dist, method = "ward.D")
isotopes.kclust=cutree(isotopes.clust,k=nk) #playing comparing community cluster vs simple hierarchical clustering
plot(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],col=rainbow(nk)[isotopes.kclust],pch=20,xlab="PC1",ylab="PC2")
plot(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],col=rainbow(nk)[isotopes.kclust],pch=20,xlab="PC1",ylab="PC2",main="tSNE")

plot(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],col=rainbow(nk)[isotopes.kclust],pch=20,main="tSNE")
#text(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],myanmar$Site,cex=.5)
text(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],code,cex=.5)
```

netowrsk

```{r}
library(igraph)
isotopes.ew=1/(exp(as.matrix(isotopes.dist)))
isotopes.graph=graph.adjacency(isotopes.ew, mode = "undirected", weighted = TRUE, diag = FALSE)
V(isotopes.graph)$label=as.character(myanmar$Site)
V(isotopes.graph)$label.cex=.4
V(isotopes.graph)$size=8
V(isotopes.graph)$frame.color="black"
V(isotopes.graph)$frame.width=.5
V(isotopes.graph)$label.color=adjustcolor("black",.6)
E(isotopes.graph)$color=NA
isotopes.graph=set_graph_attr(isotopes.graph,"layout",layout_with_fr(isotopes.graph))
plot(isotopes.graph)
```

```{r louvain,results="hold",fig.cap="simple visualisation of the network with louvain communities. We label node given the site (left) and site + period (right)  where the artefact has been found.",out.width="50%",fig.show="hold",eval=F}
par(mar=c(0,0,0,0))
isotopes.louvain=cluster_louvain(isotopes.graph)
#while(length(table(isotopes.louvain$memberships[1,]))!=10)isotopes.louvain=cluster_louvain(isotopes.graph)
#isotopes.louvain=multilevel.community(isotopes.graph)
counts=as.data.frame(sort(table(isotopes.louvain$membership)))
colnames(counts)=c("community","size")
knitr::kable(counts)
plot(isotopes.graph,vertex.color=rainbow(length(isotopes.louvain),alpha=.6)[isotopes.louvain$membership])

plot(isotopes.graph,vertex.color=rainbow(length(isotopes.louvain),alpha=.6)[isotopes.louvain$membership],vertex.label=paste(myanmar$Site,myanmar$relative.period,sep="-"))

plot(st_geometry(windowmyan),lwd=0.1)
points(myanmar$Easting...Longitude,myanmar$Northing.Latitude ,pch=21,bg=rainbow(length(isotopes.louvain),alpha=.6)[isotopes.louvain$membership])
```

## Site Network

```{r,eval=F}
joined=cbind(myanmar,louvain=isotopes.louvain$membership)
sites=unique(joined$Site)

system.time({
matdim1=sapply(sites,function(s1) sapply(sites,function(s2) simpmatch(joined$louvain[ joined$Site == s1],joined$louvain[ joined$Site == s2])))
})

system.time({
matdim2=matrix(NA,nrow=length(sites),ncol=length(sites))
for(s1 in 1:length(sites)){
    for(s2 in 1:length(sites)){
        c1=joined$louvain[ joined$Site == sites[s1]]
        c2=joined$louvain[ joined$Site == sites[s2]]
        matdim2[s1,s2]=simpmatch(c1,c2)
    }
}
})
sum(matdim2-matdim1)

sites.graph=graph.adjacency(matdim1, mode = "undirected", weighted = TRUE, diag = FALSE)
V(sites.graph)$label=as.character(sites)
V(sites.graph)$label.cex=.7
V(sites.graph)$size=8
V(sites.graph)$label.color="black"
E(sites.graph)$color=NA
sites.graph=set_graph_attr(sites.graph,"layout",layout_nicely(sites.graph))

```

visualise  communities of sites

```{r,out.width="100%"}
par(mar=c(0,0,0,0))
sites.communities=cluster_louvain(sites.graph)
comus=sites.communities$memberships[1,]

plot(sites.graph,vertex.color=rainbow(length(table(comus)),alpha=.6)[comus])
plot(st_geometry(windowmyan),lwd=0.1)
points(joined$Easting...Longitude,joined$Northing.Latitude ,pch=21,bg=rainbow(length(table(comus)),alpha=.6)[comus])

comus=sites.communities$memberships[nrow(sites.communities$memberships),]

plot(sites.graph,vertex.color=rainbow(length(table(comus)),alpha=.6)[comus])
plot(windowmyan,lwd=0.1)
points(joined$Easting...Longitude,joined$Northing.Latitude ,pch=21,bg=rainbow(length(table(comus)),alpha=.6)[comus])

```

```{r}

samegroups=pryce[pryce$Artefact.type %in% c("Slag","Ingot"),]
#remove weirdos
samegroups=samegroups[samegroups$LABEL.analytical != "SEALIP/TH/NPW/1",]

minim=sapply(unique(samegroups$Site.abreviation),function(site){
    sitesratio=samegroups[samegroups$Site.abreviation == site,ratioiso]
    apply(sitesratio,2,ratioSpan)
}
)

knitr::kable((1-apply(minim,1,min))*100 )
knitr::kable(t(minim))

oliselection=minim[,c("PBL","NPW","NKH")]
knitr::kable(t(oliselection))
recomp=(1-apply(oliselection,1,min))*100
knitr::kable(recomp)
recomp=1-apply(oliselection,1,min)
```

Which correspond to oli's computation:
```{r,results="asis"}
olidiff=read.csv("data/prod sys var.csv",header=F)
knitr::kable(olidiff[6,c(4,6,8)]-recomp)
```

On va donc ensuite comparer chaque element deux a deux et voir quel ratios sont inferieur aux ratio min calculé precedement

Using this as a graph

```{r}
sitecol=rainbow(length(unique(myanmar$Site.abreviation)),alpha=.8)
names(sitecol)=unique(myanmar$Site.abreviation)

library(igraph)
adjmat=createRatioMatrix(myanmar,ratioiso,recomp)

par(mar=c(0,0,0,0))
limited=adjmat
for(i in 0:3){
    graph=graphFromAdj(limited,mask=i,label=myanmar$Site.abreviation)
    V(graph)$color=sitecol[myanmar$Site.abreviation]
    plot(graph)
}
```

Let use this simplified matrix to detect groups
```{r,out.width="50%"}
par(mar=c(0,0,0,0))
allgraphs=lapply(0:3,function(m)graphFromAdj(limited,mask=m,label=myanmar$Site.abreviation))
allcomus=lapply(allgraphs,cluster_louvain)
allgroups=sapply(allcomus,membership)
for(i in 1:4){
    graph=allgraphs[[i]]
    V(graph)$color=allgroups[,i]
    plot(graph)
}
knitr::kable(allgroups)
```


Play with full dataset:
```{r}
allsites=createRatioMatrix(myanmar,ratioiso,recomp)
allgraphs=lapply(0:3,function(i)graphFromAdj(allsites,mask=i,label=myanmar$Site.abreviation))
alcomu=sapply(allgraphs,cluster_louvain)
allgroups=sapply(alcomu,membership)
```

Create inter basin connections

```{r,out.width="50%"}
par(mar=c(0,0,0,0))
myanmar=cbind(myanmar,allgroups)
for(i in 1:4){
    matdim2=creatSiteAdjMat(myanmar,myanmar$River.basin,allgroups[,i],match=simpmatch)
    sites.graph=graph.adjacency(matdim2, mode = "undirected", weighted = TRUE, diag = FALSE)
    allcomu=cluster_louvain(sites.graph)
    V(sites.graph)$label=unique(myanmar$River.basin)
    V(sites.graph)$color=allcomu$membership
    V(sites.graph)$label.cex=.7
    V(sites.graph)$size=8
    V(sites.graph)$label.color="black"
    E(sites.graph)$color=1
    E(sites.graph)$width=E(sites.graph)$weight/50
    #sites.graph=set_graph_attr(sites.graph,"layout",layout(c(myanmar$River.basin.coordinates.E,myanmar$River.basin.coordinates.N)))
    plot(sites.graph)
    #plot(windowmyan)
    #plot(sites.graph,layout=unique(cbind(myanmar$River.basin.coordinates.E,myanmar$River.basin.coordinates.N)),add=F)
}
```
Same with geoloc

```{r,out.width="50%"}
basinriv=myanmar[!is.na(myanmar$River.basin.coordinates.E) ,]
allsites=createRatioMatrix(basinriv,ratioiso,recomp)
allgraphs=lapply(0:3,function(i)graphFromAdj(allsites,mask=i,label=basinriv$Site.abreviation))
alcomu=sapply(allgraphs,cluster_louvain)
allgroups=sapply(alcomu,membership)
par(mar=c(0,0,0,0))
coordsites=t(sapply(V(sites.graph)$label,function(lbl)apply(unique(basinriv[basinriv$River.basin == lbl,c("River.basin.coordinates.E","River.basin.coordinates.N")]),2,mean)))
windowmyan.cr=st_crop(windowmyan,st_buffer(st_as_sf(as.data.frame(coordsites),coords=1:2,crs=st_crs(windowmyan)),dist=200000))
for(i in 1:4){
    matdim2=creatSiteAdjMat(basinriv,basinriv$River.basin,allgroups[,i],match=simpmatch)
    sites.graph=graph.adjacency(matdim2, mode = "undirected", weighted = TRUE, diag = FALSE)
    allcomu=membership(cluster_louvain(sites.graph))
    sites.graph=allgraphs[[i]]
    V(sites.graph)$label=unique(basinriv$River.basin)
    V(sites.graph)$color=allcomu
    V(sites.graph)$label.cex=.7
    V(sites.graph)$size=100
    V(sites.graph)$label.color="black"
    E(sites.graph)$color=allcomu[head_of(sites.graph,E(sites.graph))]

    E(sites.graph)$width=E(sites.graph)$weight/10
    plot(st_geometry(windowmyan.cr),reset=F)
    plot(sites.graph,layout=coordsites,add=T,rescale=F)
}


```



Using sites instead of River Basin

First we remove site with few artefacts:

```{r}
countsite=table(myanmar$Site.abreviation)
bignames=names(countsite[countsite>2])
bigsite=myanmar[!is.na(myanmar$Easting...Longitude) ,]
bigsite=bigsite[bigsite$Site.abreviation %in% bignames ,]
```


```{r,out.width="50%"}
par(mar=c(0,0,0,0))
allmatdim=lapply(1:4,function(i)creatSiteAdjMat(bigsite,bigsite$Site.abreviation,allgroups[,i],match=simpmatch))
allgraphs=lapply(allmatdim,graph.adjacency, mode = "undirected", weighted = TRUE, diag = FALSE)
allclus=lapply(allgraphs,cluster_louvain)
allcommus=sapply(allclus,membership)
for(i in 1:4){
    sites.graph=allgraphs[[i]]
    V(sites.graph)$label=unique(bigsite$Site.abreviation)
    V(sites.graph)$color=allcommus[,i]
    V(sites.graph)$label.cex=.7
    V(sites.graph)$size=8
    V(sites.graph)$label.color="black"
    E(sites.graph)$color=1
    E(sites.graph)$width=E(sites.graph)$weight/50
    plot(sites.graph)
}
```

Same but with geoloc
```{r,out.width="50%"}
par(mar=c(0,0,0,0))
coordsites=t(sapply(V(sites.graph)$label,function(lbl)apply(unique(bigsite[bigsite$Site.abreviation == lbl,c("Easting...Longitude","Northing.Latitude")]),2,mean)))
windowmyan.cr=st_crop(windowmyan,st_buffer(st_as_sf(as.data.frame(coordsites),coords=1:2,crs=st_crs(windowmyan)),dist=200000))
for(i in 1:4){
    sites.graph=allgraphs[[i]]
    V(sites.graph)$label=unique(bigsite$Site.abreviation)
    V(sites.graph)$color=allcommus[,i]
    V(sites.graph)$label.cex=.7
    V(sites.graph)$size=100
    V(sites.graph)$label.color="black"
    E(sites.graph)$color=allcommus[head_of(sites.graph,E(sites.graph)),i]

    E(sites.graph)$width=E(sites.graph)$weight/80
    plot(st_geometry(windowmyan.cr),reset=F)
    plot(sites.graph,layout=coordsites,add=T,rescale=F)
}


```
