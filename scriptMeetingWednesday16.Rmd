---
title: "Isotpo"
author: "SC"
date: "`r Sys.time()`"
output: 
    bookdown::html_document2:
        code_folding: show
        section_numbers: true
        toc: true
        toc_depth: 3
        toc_float: true
---

# Isotope data


```{r}
library(sf)
seashapefile=st_read("Cartes/allsea.shp")
seashapefile=st_make_valid(seashapefile)
seashapefile=st_union(seashapefile)

```

```{r}
pryce=read.csv("data/DATA isotopie_Pryce_V4.csv")
pryce[,c("Easting...Longitude","Northing.Latitude")]=apply(pryce[,c("Easting...Longitude","Northing.Latitude")],2,as.numeric)
pryce[,c("River.basin.coordinates.E","River.basin.coordinates.N")]=apply(pryce[,c("River.basin.coordinates.E","River.basin.coordinates.N")],2,as.numeric)
pryce=pryce[!is.na(pryce$River.basin.coordinates.E),]
ratioiso=c("X208Pb.204Pb","X207Pb.204Pb","X206Pb.204Pb")
pryce[,ratioiso]=apply(pryce[,ratioiso],2,as.numeric)
```
We get only some "clean" artefacts:


```{r}
cleanlist=pryce[pryce$Corrosion.products %in% c("Low","Ingot","Slag"),]
persite=table(cleanlist$Site.abreviation)
cleanlist=pryce[pryce$Site.abreviation %in% names(persite)[persite>9] & pryce$Corrosion.products %in% c("Low","Ingot","Slag"),]
sitecol=rainbow(length(unique(cleanlist$Site.abreviation)),alpha=.8)
names(sitecol)=unique(cleanlist$Site.abreviation)
plot(cleanlist[,ratioiso[3:2]],bg=sitecol[cleanlist$Site.abreviation],pch=20+as.numeric(as.factor(cleanlist$Country)))
plot(cleanlist[,ratioiso[c(3,1)]],bg=sitecol[cleanlist$Site.abreviation],pch=20+as.numeric(as.factor(cleanlist$Country)))
val=legend("topleft",fill=sitecol,legend=names(sitecol),title="Site",bty="n")
newxleg=val$rect$left+val$rect$w
newyleg=val$rect$top

legend(x=newxleg,y=newyleg,pch=20+1:length(unique(cleanlist$Country)),legend=levels(as.factor(cleanlist$Country)),title="Country",bty="n")
```

Using tsnea to separate artefacts

```{r}
library(Rtsne)
isotopes.tsne=Rtsne(as.matrix(cleanlist[,ratioiso]),pca=F)
plot(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],bg=sitecol[cleanlist$Site.abreviation],pch=20+as.numeric(as.factor(cleanlist$Country)))
text(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],pryce[pryce$Corrosion.products %in% c("Low","Ingot","Slag"),"Site.abreviation"],cex=.6)
```


Faire les distance "à la oli" => groupe les artefact avec une difference <.1%


D'abord recalculer les difference maximum entre les ratio ingot/slag d'un même sites:

```{r}
ratioSpan  <-  function(a,b=NULL){
    maxr=NULL
    minr=NULL
    if(length(a)>=2){
        maxr=max(a)
        minr=min(a)
    }
    else{
        maxr=max(a,b)
        minr=min(a,b)
    }
    minr/maxr
}
samegroups=pryce[pryce$Artefact.type %in% c("Slag","Ingot"),]
#remove weirdos
samegroups=samegroups[samegroups$LABEL.analytical != "SEALIP/TH/NPW/1",]

minim=sapply(unique(samegroups$Site.abreviation),function(site){
    sitesratio=samegroups[samegroups$Site.abreviation == site,ratioiso]
    apply(sitesratio,2,ratioSpan)
}
)

(1-apply(minim,1,min))*100
knitr::kable(t(minim))

oliselection=minim[,c("PBL","NPW","NKH")]
knitr::kable(t(oliselection))
recomp=(1-apply(oliselection,1,min))*100
knitr::kable(recomp)
recomp=1-apply(oliselection,1,min)
```

Which correspond to oli's computation:
```{r}
olidiff=read.csv("data/prod sys var.csv",header=F)
knitr::kable(olidiff[6,c(4,6,8)]-recomp)
```

On va donc ensuite comparer chaque element deux a deux et voir quel ratios sont inferieur aux ratio min calculé precedement


```{r}

same <- function(a,b=NULL,threshold=0.01){
    maxr=minr=NULL
    if(length(a)==2){
        maxr=max(a)
        minr=min(a)
    }
    else{
        maxr=max(a,b)
        minr=min(a,b)
    }
    if(1-(minr/maxr) <= threshold) return(1)
    else return(0)
}

#cleanlist: dataframe
# ratioiso the column used to store isotope ratio
#threshold the threshold for each ratio
createRatioMatrix <- function(dataset,ratioiso,thresholds){
    adjmat=matrix(0,nrow=nrow(dataset),ncol=nrow(dataset))
    for(i in 1:(nrow(dataset)-1)){
        for(j in (i+1):nrow(dataset)){
            adjmat[j,i]=adjmat[i,j]=sum(sapply(ratioiso,function(iso)same(dataset[c(i,j),iso],threshold=thresholds[iso])))
        }
    }
    return(adjmat)
}
       


```


Using this as a graph

```{r}
library(igraph)
adjmat=createRatioMatrix(cleanlist,ratioiso,recomp)

graphFromAdj <- function(adjmat,mask=NULL,label=NULL){
    if(!is.null(mask)){
        adjmat[adjmat<mask]=0
        adjmat[adjmat>=mask]=1
    }
    graph=graph_from_adjacency_matrix(adjmat,diag=F,weighted=T,mode="undirected")
    V(graph)$label=label
    V(graph)$size=8
    V(graph)$frame.color="black"
    V(graph)$frame.width=.5
    V(graph)$label.color=adjustcolor("black",.6)
    E(graph)$color="black"
    E(graph)$width=.4
    #E(graph)$arrow.mode="-"
    graph=set_graph_attr(graph,"layout",layout_with_fr(graph))
    graph
}
```

```{r,width.out="33%"}

par(mar=c(0,0,0,0)
limited=adjmat
for(i in 1:3){
    graph=graphFromAdj(limited,mask=i,label=cleanlist$Site.abreviation)
    V(graph)$color=sitecol[cleanlist$Site.abreviation]
    plot(graph)
}
```

Let use this simplified matrix to detect groups
```{r}

for(i in 1:3){
    graph=graphFromAdj(limited,mask=i,label=cleanlist$Site.abreviation)
    V(graph)$color=allgroups[,i]
    plot(graph)
}

allgroups=sapply(1:3,function(m)cluster_louvain(graphFromAdj(limited,mask=m,label=cleanlist$Site.abreviation))$membership)
knitr::kable(allgroups)
``


Play with full dataset:
```{r}
allsites=createRatioMatrix(pryce,ratioiso,recomp)
allgraphs=lapply(1:3,function(i)graphFromAdj(allsites,mask=i,label=cleanlist$Site.abreviation))
alcomu=sapply(allgraphs,cluster_louvain)
allgroups=sapply(alcomu,membership)
plot(pryce$Easting...Longitude,pryce$Northing.Latitude,col=alcomu[[1]]$membership,pch=20)
```

Create inter basin connections

```{r}
pryce=cbind(pryce,allgroups)
sites=unique(pryce$River.basin)
matdim2=matrix(NA,nrow=length(sites),ncol=length(sites))
for(s1 in 1:length(sites)){
    for(s2 in 1:length(sites)){
        c1=pryce[["1"]][ pryce$River.basin == sites[s1]]
        c2=pryce[["1"]][ pryce$River.basin == sites[s2]]
        matdim2[s1,s2]=simpmatch(c1,c2)
    }
}
sites.graph=graph.adjacency(matdim2, mode = "undirected", weighted = TRUE, diag = FALSE)
V(sites.graph)$label=as.character(sites)
V(sites.graph)$label.cex=.7
V(sites.graph)$size=8
V(sites.graph)$label.color="black"
E(sites.graph)$color=NA
sites.graph=set_graph_attr(sites.graph,"layout",layout(c(pryce$River.basin.coordinates.E,pryce$River.basin.coordinates.N)))
plot(sites.graph,layout=cbind(pryce$River.basin.coordinates.E,pryce$River.basin.coordinates.N))
```

