---
title: ""
author: "SC"
date: "12/2021"
output: 
    html_document:
        code_folding: show
        section_numbers: true
        toc: true
        toc_depth: 3
        toc_float: true
---

# R-version of Community structure of copper supply networks in the prehistoric Balkans: An independent evaluation of the archaeological record from the 7th to the 4th millennium BC


## Get Data

```{r,initialisation}
knitr::opts_chunk$set(warning=FALSE,message=FALSE,cache=TRUE,collapse=TRUE,fig.show="hold",results="hide")
```

Code Jelena other comnunity bipartite between metal mix and artefact
4thousand years
20000-30000

Get the data 

```{r}
datappm=read.csv("Table S1.csv")
ppms=datappm[,15:21]
plot(ppms,pch=20,cex=.7,col=adjustcolor(1,.2))
```

Check the correaltion between the elements' ppm

```{r,results="asis"}
knitr::kable(cor(ppms))
```

## Log transform

```{r}
ppms=as.data.frame(apply(ppms,2,log))
plot(ppms,pch=20,cex=.7,col=adjustcolor(1,.2))
```

Check the correlations between ppms when log transformed

```{r,results="asis"}
knitr::kable(cor(ppms))
```

## PCA 

Compute PCA scores:

```{r}
ppms.pca=prcomp(ppms)
ppms.dist=dist(ppms.pca$x)
ppms.clust=hclust(ppms.dist)
ppms.kclust=cutree(ppms.clust,k=10) #playing comparing community cluster vs simple hierarchical clustering

plot(ppms.pca$x[,1:2],col=datappm$Chemical.cluster+1)
points(ppms.pca$x[,1:2],col=ppms.kclust,pch=20  )
```
We know transform the result of the PCA as a graph:

```{r}

library(igraph)
ppms.ew=1/(as.matrix(ppms.dist)^2)
ppms.graph=graph.adjacency(ppms.ew, mode = "undirected", weighted = TRUE, diag = FALSE)
layout=layout_nicely(ppms.graph)
plot(ppms.graph,layout=layout)
```

Use this graph to  compute the communities

```{r}
communites=cluster_louvain(ppms.graph)
knitr::kable(sizes(communites))
plot(ppms.graph,vertex.color=rainbow(6,alpha=.6)[communites$membership],edge.color="white",layout=layout)

```

Looks like the `cluster_louvain` function return only the "first level" mentionned in the original paper, with 6 communities. Not sure how to go 

```{r}
knitr::kable(table(datappm$Chemical.cluster))
knitr::kable(sizes(communites))

sum(datappm$Chemical.cluster==0 & communites$membership ==4)
sum(datappm$Chemical.cluster==1 & communites$membership ==5)
sum(datappm$Chemical.cluster==2 & communites$membership ==1)
sum(datappm$Chemical.cluster==4 & communites$membership ==3)
sum(datappm$Chemical.cluster==5 & communites$membership ==6)
sum(datappm$Chemical.cluster==9 & communites$membership ==2)


# jelena 4 is  R louvain 3
# jelena 2 is  R louvain 1
# jelena 9 is  R louvain 2
```


```{r,out.width="50%"}
par(mar=c(0,0,0,0))
plot(ppms.graph,vertex.color=rainbow(6,alpha=.6)[communites$membership],edge.color=NA,layout=layout,vertex.label=NA,vertex.size=8)
plot(ppms.graph,vertex.color=rainbow(10,alpha=.6)[datappm$Chemical.cluster],edge.color=NA,layout=layout,vertex.label=NA,vertex.size=8)
```


```{r}

level2=lapply(communites, function(g)cluster_louvain(induced.subgraph(ppms.graph,g)))



```


