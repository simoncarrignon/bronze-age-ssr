---
title: "isotope data"
author: "SC"
date: "`r Sys.time()`"
output: 
    bookdown::html_document2:
        code_folding: show
        section_numbers: true
        toc: true
        toc_depth: 3
        toc_float: true
---

# Isotope data

```{r}
fun_range <- function(x,n=100) {                              # Create user-defined function
  (x - min(x)) / (max(x) - min(x)) * 100
}
```
Get all shapefiles
```{r,eval=F}
allshapefiles=lapply(country,function(m) tmpm=readOGR(dsn = "Cartes/", layer=paste0(m,"_adm0") ))
seashapefile=do.call("rbind",allshapefiles)
```

```{r}
seashapefile=writeOGR(dsn="Cartes/",layer="allsea")
```

```{r,out.width="50%"}
pryce=read.csv("data/Lead isotope data_PRYCE.csv")
pryce[,11:15]=apply(pryce[,11:15],2,as.numeric)
pryce=pryce[!is.na(pryce[,11]),]
isotopes=pryce[,11:15]
pryce.pca=prcomp(pryce[,11:15])
pryce.dist=dist(pryce.pca$x)
pryce.clust=hclust(pryce.dist)
pryce.kclust=cutree(pryce.clust,k=10) #playing comparing community cluster vs simple hierarchical clustering
plot(pryce.pca$x[,1:2],pch=21,bg=rainbow(10,alpha=.6)[pryce.kclust])
plot(pryce.pca$x[,1:2],pch=21,bg=rainbow(10,alpha=.6)[pryce.kclust])
text(pryce.pca$x[,1],pryce.pca$x[,2],pryce$Region,pch=21,bg=rainbow(10,alpha=.6)[pryce.kclust],cex=.4)

pryce$Easting...Longitude= as.numeric(gsub("°","",pryce$Easting...Longitude))
pryce$Northing.Latitude= as.numeric(gsub("°","",pryce$Northing.Latitude))
plot(pryce$Easting...Longitude,pryce$Northing.Latitude,pch=21,bg=rainbow(10,alpha=.6)[pryce.kclust])


```

Tsnea and networks:
```{r}

library(Rtsne)
isotopes.tsne=Rtsne(isotopes,pca=F)
isotopes.dist=dist(isotopes.tsne$Y)
isotopes.clust=hclust(isotopes.dist, method = "ward.D")
isotopes.kclust=cutree(isotopes.clust,k=13) #playing comparing community cluster vs simple hierarchical clustering
plot(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],col=rainbow(13)[isotopes.kclust],pch=20,xlab="PC1",ylab="PC2")
plot(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],col=rainbow(13)[isotopes.kclust],pch=20,xlab="PC1",ylab="PC2",main="tSNE")

plot(isotopes.tsne$Y[,1],isotopes.tsne$Y[,2],col=rainbow(13)[isotopes.kclust],pch=20,main="tSNE")
text(ppms.tsne$Y[,1],ppms.tsne$Y[,2],datappm$Region,cex=.5)
```

netowrsk
```{r}

isotopes.ew=1/(as.matrix(isotopes.dist)^2)
isotopes.graph=graph.adjacency(isotopes.ew, mode = "undirected", weighted = TRUE, diag = FALSE)
V(isotopes.graph)$label=as.character(datappm$Country)
V(isotopes.graph)$label.cex=.4
V(isotopes.graph)$size=8
V(isotopes.graph)$frame.color="black"
V(isotopes.graph)$frame.width=.5
V(isotopes.graph)$label.color=adjustcolor("black",.6)
E(isotopes.graph)$color=NA
isotopes.graph=set_graph_attr(isotopes.graph,"layout",layout_with_fr(isotopes.graph))
plot(isotopes.graph)
```


Try ternary plots:

```{r}
#install.packages("ggtern")
devtools::install_git('https://bitbucket.org/nicholasehamilton/ggtern')
library(ggtern)

pryce[,13:15]=apply(pryce[,13:15],1,function(i)i/sum(i))
only=pryce[,c(13:15)]
colnames(only)=c("208Pb","207Pb","206Pb")
#only=t(apply(only,1,function(i)i/sum(i)))
onlys=as.data.frame(apply(only,2,fun_range,n=50))
only=as.data.frame(only)
par(xpd=T)
ggtern(onlys ,aes(A,B,C))+theme_bw()+ geom_point(color=as.numeric(as.factor(pryce$Region)))+geom_mask()
legend("topright",legend=unique(as.factor(pryce$Region)),col=unique(as.numeric(as.factor(pryce$Region))))
ggtern(only ,aes(A,B,C))+
geom_density_tern(aes(fill=as.numeric(as.factor(pryce$Region))),bins=10) + geom_point(color=as.numeric(as.factor(pryce$Region)))


ggtern(onlys ,aes(A,B,C,color=pryce$Region)) +
  theme_bw() + geom_mask() +
  geom_point()



  scale_T_continuous(limits=c(0.2,0.3),
                     breaks=seq(0,1,by=0.01))+
                     #labels=paste0("B",LETTERS[1:11])) + 
  scale_L_continuous(limits=c(0.5,0.6),
                     breaks=seq(0,1,by=0.01))+
                     #labels=paste0("A",LETTERS[1:11])) + 
  scale_R_continuous(limits=c(0.2,0.3),
                     breaks=seq(0,1,by=0.01))
                     #labels=paste0("C",LETTERS[1:11]))

ggtern(only ,aes(A,B,C))+geom_point(color=as.numeric(as.factor(pryce$Region)))+
  scale_T_continuous(limits=c(0.18,0.25),
                     breaks=seq(0,1,by=0.01))+
                     #labels=paste0("B",LETTERS[1:11])) + 
  scale_L_continuous(limits=c(0.54,0.6),
                     breaks=seq(0,1,by=0.01))+
                     #labels=paste0("A",LETTERS[1:11])) + 
  scale_R_continuous(limits=c(0.20,0.27),
                     breaks=seq(0,1,by=0.01))
 limit_tern(1.0,0.5,0.5)
tern_limits(.25,.8,.40)
geom_density_tern(aes(fill=..level..),bins=5) +
 geom_point()
plot(pryce[,11:12],col=as.factor(pryce$Region),pch=20)
plot3D(pryce[,11],pryce[,12],pryce[,15])

Ternary::TernaryPlot(xlim=c(-0.032,-0.01),ylim=c(.455,.465),padding=0,isometric=F)



data('Feldspar')
ggtern(Feldspar,aes(Ab,An,Or)) + 
 geom_density_tern(aes(color=..level..),bins=20) +
 geom_point()

df = data.frame(x = runif(50)*1000,
                y = runif(50)*1000,
                z = runif(50)*1000,
                Group = as.factor(round(runif(50,1,2))))
ggtern(data=df,aes(x,y,z),color=Group)
ggtern() + 
  geom_point(data = df, aes(x/10, y/10, z/10, color = Group)) + 
  labs(x="X", y="Y", z="Z", title="Title") +
  scale_T_continuous(breaks = seq(0,1,0.2), labels = 1000*seq(0,1,0.2)) +
  scale_L_continuous(breaks = seq(0,1,0.2), labels = 1000*seq(0,1,0.2)) +
  scale_R_continuous(breaks = seq(0,1,0.2), labels = 1000*seq(0,1,0.2))
```

